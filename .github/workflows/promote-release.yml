# SPDX-License-Identifier: Apache-2.0
# Licensed to the Ed-Fi Alliance under one or more agreements.
# The Ed-Fi Alliance licenses this file to you under the Apache License, Version 2.0.
# See the LICENSE and NOTICES files in the project root for more information.

name: Promote to Release

on:
  workflow_dispatch:
    inputs:
      view-type:
        type: choice
        description: package-label
        options:
        - Prerelease
        - Release
        required: true

env:
  ARTIFACTS_API_KEY: ${{ secrets.AZURE_ARTIFACTS_PERSONAL_ACCESS_TOKEN }}
  ARTIFACTS_FEED_URL: ${{ secrets.AZURE_ARTIFACTS_FEED_URL }}
  ARTIFACTS_PACKAGES_URL: ${{ secrets.ARTIFACTS_PACKAGES_URL }}
  ARTIFACTS_USERNAME: ${{ secrets.AZURE_ARTIFACTS_USER_NAME }}

jobs:
  promote-packages:

    runs-on: ubuntu-latest

    defaults:
      run:
        shell: pwsh

    steps:
    - name: Promote Packages
      run: |
        $arguments = @{
          FeedsURL    = "${{ env.ARTIFACTS_FEED_URL }}"
          PackagesURL = "${{ env.ARTIFACTS_PACKAGES_URL }}"
          Username    = "${{ env.ARTIFACTS_USERNAME }}"
          View        = "${{ github.event.inputs.view-type }}"
        }
        $arguments.Password = (ConvertTo-SecureString -String "${{ secrets.ARTIFACTS_API_KEY }}" -AsPlainText -Force)
        $arguments.Packages = @('EdFi.Suite3.ODS.AdminApp.Database', 'EdFi.Suite3.ODS.AdminApp.Web', 'EdFi.Suite3.ODS.Admin.Api')
        eng\promote-packages.ps1 @arguments
