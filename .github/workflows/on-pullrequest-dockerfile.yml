# SPDX-License-Identifier: Apache-2.0
# Licensed to the Ed-Fi Alliance under one or more agreements.
# The Ed-Fi Alliance licenses this file to you under the Apache License, Version 2.0.
# See the LICENSE and NOTICES files in the project root for more information.

name: On Pull Request - Dockerfile

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/on-pullrequest-dockerfile.yml"
      - "Docker/*"
  pull_request:
    branches:
      - main
    paths:
      - ".github/workflows/on-pullrequest-dockerfile.yml"
      - "Docker/*"
  workflow_dispatch:

env:
  DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}
  DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}
  IMAGE_VERSION: pre-1.3

jobs:
  docker-published:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        dockerfile: [
          { name: "api-database", path: "Docker/Settings/DB-Admin/pgsql/Dockerfile" },
          { name: "postgres", path: "Docker/Dockerfile" }
          ]
    steps:
    - name: Checkout code
      uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0

    - uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf # v3.1.0
      name: Run Linter on ${{ matrix.dockerfile.name }} Dockerfile
      with:
        dockerfile: ${{ matrix.dockerfile.path }}
        failure-threshold: error

    - name: Log in to Docker Hub
      uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a  # v2.1.0
      with:
        username: ${{ env.DOCKER_USERNAME }}
        password: ${{ env.DOCKER_HUB_TOKEN }}

    - name: Set Version Numbers
      id: versions
      shell: pwsh
      run: |
        echo ${{ github.ref_name }}
        "VERSION=2.0.1" >> $env:GITHUB_OUTPUT

    - name: Build
      run: |
        path=${{matrix.dockerfile.path}}
        folder=${path%/*}
        cd $folder
        dockerfile=$(echo ${{matrix.dockerfile.path}} | awk -F"/" '{print $NF}')
        docker build -f $dockerfile -t ${{ matrix.dockerfile.name }} --build-arg="VERSION=${{ steps.versions.outputs.VERSION }}" .

    - name: Analize
      uses: docker/scout-action@4e9ac4df44fb56797da111fce8185f7fbffd5a09 # v1.0.9
      with:
        command: cves
        image: local://${{ matrix.dockerfile.name }}
        sarif-file: sarif-${{ matrix.dockerfile.name }}.output.json
        summary: true

    - name: Upload SARIF result
      id: upload-sarif
      if: ${{ github.event_name != 'pull_request_target' }}
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: sarif-${{ matrix.dockerfile.name }}.output.json

  docker-local:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        dockerfile: [
          { name: "database", path: "dbadmin.Dockerfile" },
          { name: "development", path: "dev.Dockerfile" },
          ]
    defaults:
      run:
        working-directory: Docker

    steps:
    - name: Checkout code
      uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0

    - name: Copy application folder to docker context
      if:
      run: |
        mkdir Application
        cp -r ../Application/EdFi.Ods.AdminApi ./Application
        cp ../Application/NuGet.Config ./Application

    - uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf # v3.1.0
      name: Run Linter on ${{ matrix.dockerfile.name }} Dockerfile
      with:
        dockerfile: Docker/${{ matrix.dockerfile.path }}
        failure-threshold: error

    - name: Log in to Docker Hub
      uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a  # v2.1.0
      with:
        username: ${{ env.DOCKER_USERNAME }}
        password: ${{ env.DOCKER_HUB_TOKEN }}

    - name: Build
      run: docker build -f ${{ matrix.dockerfile.path }} -t ${{ matrix.dockerfile.name }} .
      env:
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: abcdefgh1!

    - name: Analize
      uses: docker/scout-action@4e9ac4df44fb56797da111fce8185f7fbffd5a09 # v1.0.9
      with:
        command: cves
        image: local://${{ matrix.dockerfile.name }}
        sarif-file: sarif-${{ matrix.dockerfile.name }}.output.json
        summary: true

    - name: Upload SARIF result
      id: upload-sarif
      if: ${{ github.event_name != 'pull_request_target' }}
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: sarif-${{ matrix.dockerfile.name }}.output.json


  # docker-analysis:
  #   runs-on: ubuntu-latest
  #   steps:

  #     - name: Log in to Docker Hub
  #       uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a  # v2.1.0
  #       with:
  #         username: ${{ env.DOCKER_USERNAME }}
  #         password: ${{ env.DOCKER_HUB_TOKEN }}

  #     # - name: SBOM
  #     #   uses: docker/scout-action@4e9ac4df44fb56797da111fce8185f7fbffd5a09 # v1.0.9
  #     #   with:
  #     #     command: sbom
  #     #     image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_VERSION }}

  #     - run: ls
