# SPDX-License-Identifier: Apache-2.0
# Licensed to the Ed-Fi Alliance under one or more agreements.
# The Ed-Fi Alliance licenses this file to you under the Apache License, Version 2.0.
# See the LICENSE and NOTICES files in the project root for more information.

name: On Pull Request - Dockerfile

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/on-pullrequest-dockerfile.yml"
      - "Docker/*"
  pull_request:
    branches:
      - main
    paths:
      - ".github/workflows/on-pullrequest-dockerfile.yml"
      - "Docker/*"
  workflow_dispatch:

env:
  DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}
  DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}
  IMAGE_VERSION: pre-1.3

jobs:
  docker-testing:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        dockerfile: [
            { name: "api-database", path: "Docker/Settings/DB-Admin/pgsql" },
            # { name: "postgres", path: "Docker/pgsql.Dockerfile" },
            # { name: "sql-server", path: "Docker/mssql.Dockerfile" },
            # { name: "database", path: "Docker/dbadmin.Dockerfile" },
            # { name: "development", path: "Docker/dev.Dockerfile" },
          ]
    steps:
      - name: Checkout code
        uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0

      # - name: Run Linter on ${{ matrix.dockerfile.name }} Dockerfile
      #   uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf # v3.1.0
      #   with:
      #     dockerfile: ${{ matrix.dockerfile.path }}
      #     failure-threshold: error

      - name: Log in to Docker Hub
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a  # v2.1.0
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_HUB_TOKEN }}

      # - name: Build
      #   run: |
      #     cd ${{ matrix.dockerfile.path }}
      #     docker build -t ${{ matrix.dockerfile.name }} .

      - name: Analize
        uses: docker/scout-action@4e9ac4df44fb56797da111fce8185f7fbffd5a09 # v1.0.9
        with:
          command: cves
          # image: local://${{ matrix.dockerfile.name }}
          image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_VERSION }}
          sarif-file: sarif-${{ matrix.dockerfile.name }}.output.json
          summary: true

      - name: Upload SARIF result
        id: upload-sarif
        if: ${{ github.event_name != 'pull_request_target' }}
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: sarif-${{ matrix.dockerfile.name }}.output.json

      # - run: ls


  # docker-analysis:
  #   runs-on: ubuntu-latest
  #   steps:

  #     - name: Log in to Docker Hub
  #       uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a  # v2.1.0
  #       with:
  #         username: ${{ env.DOCKER_USERNAME }}
  #         password: ${{ env.DOCKER_HUB_TOKEN }}

  #     # - name: SBOM
  #     #   uses: docker/scout-action@4e9ac4df44fb56797da111fce8185f7fbffd5a09 # v1.0.9
  #     #   with:
  #     #     command: sbom
  #     #     image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_VERSION }}

  #     - run: ls
